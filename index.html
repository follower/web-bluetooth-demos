<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Web Bluetooth API demos for Chrome - We Vibe : ">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/materialize.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/custom.css">

    <title>Web Bluetooth API demos for Chrome - We Vibe</title>
  </head>

  <body>

      <!-- HEADER -->
      <header class="center-align">
        <div class="container">
          <a class="forkme_banner" href="https://github.com/goldfisk/web-bluetooth-demos">
            View on GitHub
          </a>

        <img src="images/weevil.svg" class="logo"/>
        <h1 id="project_title">Web Bluetooth API demos for Chrome - We Vibe</h1>
        <h2 id="project_tagline"></h2>
        </div>
      </header>

      <main>

        <div class="container">

        <section id="downloads" class="row center-align">
          <div class="col s12 m6">
            <a class="zip_download_link" href="https://github.com/goldfisk/web-bluetooth-demos/zipball/master">
              <i class="material-icons md-36">&#xE2C4;</i>
              Download this project as a .zip file
            </a>
          </div>
          <div class="col s12 m6">
            <a class="tar_download_link" href="https://github.com/goldfisk/web-bluetooth-demos/tarball/master">
              <i class="material-icons">&#xE2C4;</i>
              Download this project as a tar.gz file</a>
          </div>
        </section>

        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="center-align">
          <section id="main_content" class="main-actions">
            <button id="btn_request_device" class="btn-large pink darken-1">
              <i class="material-icons md-24">&#xE335;</i>
              Pair device
            </button>
            <button id="btn_sync_pulse" class="btn-large pink darken-2">
              <i class="material-icons md-24">&#xE627;</i>
              Sync Pulse
            </button>
            <button id="btn_read_data" class="btn-large pink darken-3">
              <i class="material-icons md-24">&#xE896;</i>
              Read Data
            </button>
            <div id="info-wrapper" style="display:none;">
              <p id="info"> </p>
            </div>
            <div>
              <h2>Select mode</h2>
              <select id="selectBox" class="btn dropdown-toggle pink darken-4" placeholder="Select mode" onchange="changePattern(value);">
                <option value="none">None</option>
                <option value="chachacha">Chachacha</option>
                <option value="vibrate">Vibrate</option>
                <option value="other">Other</option>
              </select>
            </div>
          </section>
        </div>
      <script>

        // Initial class generated by: <https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/>
        // Other references:
        //  * <https://googlechrome.github.io/samples/web-bluetooth/device-info.html>
        //  * <https://googlechrome.github.io/samples/web-bluetooth/reset-energy.html>

        class WeVibe {
        
          constructor() {
            this.device = null;
            this.onDisconnected = this.onDisconnected.bind(this);
            console.log(":D");
          }
        
          request() {
            let options = {
                          "filters": [{
                "services": ["0000bb03-0000-1000-8000-00805f9b34fb"]
              }],
              "optionalServices": ["f000bb03-0451-4000-b000-000000000000"]
            };
            return navigator.bluetooth.requestDevice(options)
            .then(device => {
              this.device = device;
              this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
              return device;
            });
          }
        
          connect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.connect();
              
            }
          }
          
          readInfo() {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000c000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.readValue());
          }
          
          writeCommand(data) {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000c000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.writeValue(data));
          }
          
          disconnect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.disconnect();
            }
          }
        
          onDisconnected() {
            console.log('Device is disconnected.');
          }
        }

        var weVibe = new WeVibe();

        document.querySelector('#btn_request_device').addEventListener('click', function() {
          if (!navigator.bluetooth) {
            alert("No Bluetooth. :(");
            return;
          }

          // TODO: Deactive other buttons until this succeeds?
          weVibe.request();
        });

        document.querySelector('#btn_sync_pulse').addEventListener('click', function() {

          weVibe.connect()
          .then(_ => {return weVibe.writeCommand(new Uint8Array([30, 32, 45, 0, 0, 0, 0, 0]));})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });
        });
        
        document.querySelector('#btn_read_data').addEventListener('click', function() {
          
          //data = new Uint8Array([15, 0, null, 0, null, null, null, null]);
          weVibe.connect()
          .then(_ => {weVibe.readInfo();})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });
          console.log(":P");
          console.log(weVibe.readInfo(););
          document.getElementById('info-wrapper').style.display = ""
          document.getElementById('info').innerHTML = data;
          
          var self = weVibe;
        return weVibe.readInfo()
          .then(function(value) {
            // In Chrome 50+, a DataView is returned instead of an ArrayBuffer.
            value = value.buffer ? value : new DataView(value);
            self.value = value;
            return self.value;
            console.log(self.value);
          });
        });
    
  function changePattern(pattern)  {
    command = null;
  if (pattern == "none")
    command = new Uint8Array([15, 0, null, 0, null, null, null, null]);
   else if (pattern == "chachacha")
    command = new Uint8Array([15, 9, null, 0, null, null, null, null]); 
    else if (pattern == "vibrate")
    command = new Uint8Array([15, 1, null, 0, null, null, null, null]); 
     else if (pattern == "other")
    command = new Uint8Array([15, 2, null, 0, null, null, null, null]); 
     weVibe.connect()
          .then(_ => {return weVibe.writeCommand(command);})
          //.then(_ => weVibe.disconnect())
          .catch(error => { console.log(error) });
  }

        </script>

      </div>

    </main>

    <footer class="page-footer">
      <div class="container">
        <p>
          Web Bluetooth API demos for Chrome - We Vibe maintained by <a href="https://github.com/goldfisk">goldfisk</a><br>
          Published with <a href="https://pages.github.com">GitHub Pages</a>
          Created using <a href="http://materializecss.com/">Materialize CSS</a> and <a href="https://design.google.com/icons/">Google Material Icons</a></p>
      </div>
    </footer>

  </body>
</html>
